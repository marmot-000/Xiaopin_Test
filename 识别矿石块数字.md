
# 红底方块白色数字识别
## 一、代码思路
### 1. 图像预处理：红色区域提取
通过HSV颜色空间分割技术，精准提取红底区域，避免RGB空间受光照影响大的问题：
- **颜色空间转换**：将输入BGR图像转为HSV格式，分离色调（H）、饱和度（S）、亮度（V）通道；
- **双区间红色掩码**：红色在HSV中跨0°边界，故设置两个阈值区间：
  - 低区间：H(0-10)、S(112-255)、V(70-255)
  - 高区间：H(160-179)、S(102-255)、V(70-255)
- **形态学优化**：3×3矩形结构元素的开运算（去噪点）和闭运算（补孔洞），得到纯净的红色掩码（`red_mask`）。

### 2. 轮廓筛选与角点提取
从红色掩码中筛选目标方块轮廓，排除非正方形干扰（如RoboMaster场地字母“E”）：
- **轮廓检测**：使用`findContours`提取掩码的外部轮廓（`RETR_EXTERNAL`模式）；
- **筛选条件**：
  - 面积过滤：排除面积＜250像素的小轮廓（噪声）；
  - 形状过滤：通过`minAreaRect`计算轮廓宽高比，仅保留宽高比≤3的近似矩形；
  - 边数过滤：通过`approxPolyDP`多边形逼近，保留4条边的轮廓（方块特征）；
- **角点排序**：以轮廓中心为原点，按角点与中心连线的夹角（`atan2`计算）排序，确保后续透视变换的坐标一致性。

### 3. 透视变换：方块矫正
将倾斜的方块转为正视图，为模板匹配提供统一尺寸的输入：
- **目标坐标定义**：设置200×200像素的正矩形目标坐标（`dst`），对应方块的左上、右上、右下、左下四个角点；
- **变换矩阵计算**：通过`getPerspectiveTransform`生成轮廓角点到目标坐标的透视矩阵；
- **正视图生成**：调用`warpPerspective`执行变换，得到标准化的方块正视图（`warped_images`）。

### 4. 模板匹配：数字识别
基于模板匹配算法，识别正视图中的白字内容，模板库包含27个模板（1-6各4个、B/O/X各1个）：
- **白字提取**：通过BGR阈值（85-105, 85-105, 95-105）生成数字二值图，2×2开运算去噪；
- **模板匹配**：使用`TM_SQDIFF`（平方差匹配）算法，计算输入二值图与所有模板的匹配差值，差值越小匹配度越高；
- **结果判定**：
  - 匹配阈值：仅保留差值＜4.2e8的有效结果；
  - 模板映射：0-23号模板对应数字1-6（每4个模板对应1个数字），24-26号模板分别对应B、O、X。

### 5. 结果可视化与输出
- **可视化标注**：在原图上绘制方块边框（彩色区分不同方块）、ID标签及角点编号（黄色实心圆）；
- **数据输出**：通过ROS日志打印方块ID、识别结果（数字/字符）及4个角点的精确坐标（保留2位小数）。


## 二、系统模块设计
系统通过`CubeNumberRecognizer`类封装核心功能，配合两个运行模式（Docker/本地），模块结构如下：

| 模块名称               | 核心函数                          | 功能描述                                  |
|------------------------|-----------------------------------|-------------------------------------------|
| 模板加载模块           | `loadNumberTemplates`             | 从指定路径加载27个灰度模板，统一缩放到200×200像素 |
| 图像预处理模块         | `processImage`                    | 完成HSV转换、红色掩码生成与形态学优化        |
| 轮廓与角点处理模块     | `getCornerPoints`                 | 轮廓筛选、4角点提取与角度排序              |
| 透视变换模块           | `perspecTransform`                | 生成方块正视图，`jointCanvas`拼接多图展示  |
| 数字识别模块           | `getDectedNumber`                 | 白字提取、模板匹配与结果映射              |
| 可视化模块             | `visualizeResults`                | 原图标注方块边框、ID与角点                |
| 运行模式模块           | `dockerMode`/`localMode`          | Docker实时相机流处理/本地单图调试          |


## 三、运行说明
### 1. 环境依赖
- 操作系统：Ubuntu 18.04/20.04（兼容ROS Melodic/Noetic）；
- 依赖库：ROS核心库、OpenCV 4.2.0+、`cv_bridge`（ROS与OpenCV图像转换）；
- 模板文件：27个PNG模板需放置在对应路径：
  - Docker模式：`/opt/ep_ws/src/rmus_solution/temple/`
  - 本地模式：`/home/robot/图片/temple/`

### 2. 运行命令
| 运行模式   | 命令格式                                      | 说明                                  |
|------------|-----------------------------------------------|---------------------------------------|
| Docker模式 | `rosrun cv_pkg cv_number_detect`              | 订阅`/camera/color/image_raw`相机话题 |
| 本地模式   | `rosrun cv_pkg cv_number_detect <图像路径>`    | 处理单张图像，如`/home/robot/3.png`   |

### 3. 输出结果示例
```
[INFO] [1761250000.123456]: successfully loading templates, sum:27
[INFO] [1761250001.678901]: 

==========Rectangles_ID:1==========
[INFO] [1761250001.678920]:  the number/char is 3
[INFO] [1761250001.678935]: Point_1:(320.50, 240.30)   
[INFO] [1761250001.678948]: Point_2:(420.10, 241.20)   
[INFO] [1761250001.678960]: Point_3:(419.80, 340.70)   
[INFO] [1761250001.678972]: Point_4:(319.90, 339.80)   
```


## 四、关键参数调整建议
1. **红色掩码阈值**：若红底提取不完整或有干扰，可调整`processImage`中的HSV区间（如降低S通道下限增强红色包容性）；
2. **模板匹配阈值**：若识别错误率高，可调整`getDectedNumber`中的`min_val < 4.2e8`（差值越小越严格，建议范围3e8-5e8）；
3. **轮廓筛选条件**：若方块漏检，可减小`getCornerPoints`中的面积阈值（如250→200）或放宽宽高比（如3→1.5）。





